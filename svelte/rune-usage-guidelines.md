# Rune の使用ガイドライン（Svelte 5）

Svelte 5 では新しいリアクティブシステムとして「Rune」が導入されました。これは `$state`, `$effect`, `$derived` などを使った直感的な状態管理を可能にします。ただし、**Rune はすべての場所で使えるわけではなく、主にクライアント側に限定されます。**

## ✅ Rune が使える場所と使えない場所

| ファイル/場所                 | Rune 使用可否 | 理由                                                                 |
|------------------------------|----------------|----------------------------------------------------------------------|
| `+page.svelte`               | ✅ 使用可能     | UI と連動する状態を管理できる                                        |
| `+layout.svelte`             | ✅ 使用可能     | グローバルな UI 状態やヘッダー・ナビゲーションなどで有用            |
| `+page.ts` / `+layout.ts`    | ⚠️ 条件付き     | `load()` で Rune は使えないが、コンポーネント内で使う前提のデータ生成には使える場合がある |
| `+page.server.ts`            | ❌ 使用不可     | SSR 実行時に1回限りで状態管理の意味がないため                       |
| `+layout.server.ts`          | ❌ 使用不可     | 同上                                                                 |
| `hooks.server.ts`            | ❌ 使用不可     | Rune のリアクティブ性が不要なサーバーロジック専用ファイル           |
| 通常の `.ts` モジュール（サーバー専用） | ❌ 使用不可     | Rune は Svelte runtime が動作するクライアント環境に依存する         |

## 📘 Rune が必要な場面

- ユーザーが UI 上でインタラクションするたびに状態が変わる場面（カウントアップ、チェック状態など）
- 複数の状態が依存し合うロジックを簡潔に書きたい場合（`$derived`）
- サブスクライブ/非同期データを自動で追従させたい場合（`$effect`）

## 🚫 Rune が使えない場面（代替方法）

| 処理内容                     | 使用不可な例            | 代替手段                                  |
|------------------------------|--------------------------|-------------------------------------------|
| 認証トークンの取得           | `+page.server.ts` 内で `$state` を使う | `load()` + `event.locals` を使って処理     |
| DBへのアクセス               | `+page.server.ts` 内で `$effect` を使う | 通常の async 関数として記述                |
| セッション情報の保持         | `hooks.server.ts` 内で `$state` を使う | `handle` フックで `event.locals` に保存     |

## ✅ 結論

- Rune は **クライアント側 UI とリアクティブな状態管理に特化**しています。
- サーバー処理では **標準の SvelteKit 機構（load, actions, hooks）** を使う構成にすることで責務を明確化できます。
- 「サーバーはデータを渡す／クライアントは表示と状態を制御する」という役割分担を意識しましょう。